{% extends 'base.html' %}

{% block title %}Заказ #{{ order.id }}{% endblock %}

{% block content %}
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{% url 'home' %}">Главная</a></li>
        <li class="breadcrumb-item"><a href="{% url 'orders:orders_list' %}">Заказы</a></li>
        <li class="breadcrumb-item active">Заказ #{{ order.id }}</li>
    </ol>
</nav>

<div class="row">
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Заказ #{{ order.id }}</h5>
                <span class="badge bg-{{ order.status_color }} fs-6">{{ order.get_status_display }}</span>
            </div>
            <div class="card-body">
                <p class="text-muted">
                    <i class="bi bi-calendar"></i> Создан: {{ order.created_at|date:"d.m.Y H:i" }}
                </p>

                <!-- История статусов -->
                <h6 class="mt-4">История статусов</h6>
                <div class="timeline">
                    {% for status in order.status_history.all %}
                    <div class="timeline-item mb-3">
                        <div class="d-flex align-items-center">
                            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px; min-width: 40px;">
                                <i class="bi bi-{{ status.icon }}"></i>
                            </div>
                            <div>
                                <strong>{{ status.get_status_display }}</strong>
                                <p class="text-muted mb-0 small">{{ status.created_at|date:"d.m.Y H:i" }}</p>
                                {% if status.comment %}
                                    <p class="mb-0 small">{{ status.comment }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Товары -->
                <h6 class="mt-4">Товары в заказе</h6>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Товар</th>
                                <th>Количество</th>
                                <th>Цена</th>
                                <th>Сумма</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in order.items.all %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        {% if item.product.images.first %}
                                            <img src="{{ item.product.images.first.image.url }}" width="50" height="50" class="rounded me-2" alt="{{ item.product.name }}">
                                        {% endif %}
                                        <a href="{% url 'products:detail' item.product.id %}">{{ item.product.name }}</a>
                                    </div>
                                </td>
                                <td>{{ item.quantity }}</td>
                                <td>{{ item.price }} ₽</td>
                                <td>{{ item.total_price }} ₽</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Услуги -->
                {% if order.services.exists %}
                <h6 class="mt-4">Дополнительные услуги</h6>
                <ul class="list-group">
                    {% for service in order.services.all %}
                    <li class="list-group-item d-flex justify-content-between">
                        <span>{{ service.service.name }}</span>
                        <strong>{{ service.price }} ₽</strong>
                    </li>
                    {% endfor %}
                </ul>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Информация о доставке -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-truck"></i> Доставка</h6>
            </div>
            <div class="card-body">
                <p class="mb-2"><strong>Способ:</strong> {{ order.delivery_method.name }}</p>
                <p class="mb-2"><strong>Адрес:</strong><br>{{ order.delivery_address }}</p>
                <p class="mb-0"><strong>Телефон:</strong> {{ order.phone }}</p>
            </div>
        </div>

        <!-- Информация об оплате -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-credit-card"></i> Оплата</h6>
            </div>
            <div class="card-body">
                <p class="mb-2"><strong>Способ:</strong> {{ order.payment_method.name }}</p>
                <p class="mb-0">
                    <strong>Статус:</strong> 
                    {% if order.is_paid %}
                        <span class="badge bg-success">Оплачен</span>
                    {% else %}
                        <span class="badge bg-warning">Ожидает оплаты</span>
                    {% endif %}
                </p>
            </div>
        </div>

        <!-- Итого -->
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0">Итого</h6>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-2">
                    <span>Товары:</span>
                    <span>{{ order.items_total }} ₽</span>
                </div>
                {% if order.services.exists %}
                <div class="d-flex justify-content-between mb-2">
                    <span>Услуги:</span>
                    <span>{{ order.services_total }} ₽</span>
                </div>
                {% endif %}
                <div class="d-flex justify-content-between mb-2">
                    <span>Доставка:</span>
                    <span>{{ order.delivery_cost }} ₽</span>
                </div>
                <hr>
                <div class="d-flex justify-content-between">
                    <strong>Итого:</strong>
                    <strong class="text-primary">{{ order.total_price }} ₽</strong>
                </div>
            </div>
        </div>

        <!-- Действия -->
        {% if order.can_cancel %}
        <button class="btn btn-outline-danger w-100 mt-3"
                hx-post="{% url 'orders:cancel_order' order.id %}"
                hx-confirm="Отменить заказ?">
            <i class="bi bi-x-circle"></i> Отменить заказ
        </button>
        {% endif %}
    </div>
</div>
{% endblock %}