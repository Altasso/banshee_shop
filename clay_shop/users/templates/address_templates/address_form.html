{% extends 'base.html' %}

{% block title %}
    {% if form.instance.pk %}
        –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ - Clay Art
    {% else %}
        –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ - Clay Art
    {% endif %}
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">–ì–ª–∞–≤–Ω–∞—è</a></li>
                <li class="breadcrumb-item"><a href="{% url 'user-detail' request.user.pk %}">–ü—Ä–æ—Ñ–∏–ª—å</a></li>
                <li class="breadcrumb-item"><a href="{% url 'address-list' %}">–ê–¥—Ä–µ—Å–∞</a></li>
                <li class="breadcrumb-item active">
                    {% if form.instance.pk %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ{% else %}–î–æ–±–∞–≤–ª–µ–Ω–∏–µ{% endif %}
                </li>
            </ol>
        </nav>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h3 class="mb-0">
                    {% if form.instance.pk %}
                        ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ –¥–æ—Å—Ç–∞–≤–∫–∏
                    {% else %}
                        üìç –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∞–¥—Ä–µ—Å–∞
                    {% endif %}
                </h3>
            </div>
            <div class="card-body p-4">
                <p class="text-muted mb-4">
                    {% if form.instance.pk %}
                        –û–±–Ω–æ–≤–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∞–¥—Ä–µ—Å–µ –¥–æ—Å—Ç–∞–≤–∫–∏
                    {% else %}
                        –î–æ–±–∞–≤—å—Ç–µ –∞–¥—Ä–µ—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤
                    {% endif %}
                </p>

                <form method="post" hx-post="{{ request.path }}" hx-target="this" hx-swap="outerHTML">
                    {% csrf_token %}
                    
                    {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        {{ form.non_field_errors }}
                    </div>
                    {% endif %}

                    <!-- Title -->
                    <div class="mb-3">
                        <label for="{{ form.title.id_for_label }}" class="form-label">
                            üè∑Ô∏è –ù–∞–∑–≤–∞–Ω–∏–µ –∞–¥—Ä–µ—Å–∞
                        </label>
                        {{ form.title }}
                        {% if form.title.errors %}
                        <div class="text-danger small mt-1">
                            {{ form.title.errors }}
                        </div>
                        {% endif %}
                        <small class="form-text text-muted">–ù–∞–ø—Ä–∏–º–µ—Ä: –î–æ–º, –†–∞–±–æ—Ç–∞, –î–∞—á–∞</small>
                    </div>

                    <hr class="my-4">
                    <h5 style="color: var(--moss-green);" class="mb-3">üìÆ –ê–¥—Ä–µ—Å —Å –∞–≤—Ç–æ–ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏</h5>

                    <!-- Address —Å –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ–º -->
                    <div class="mb-3 position-relative">
                        <label for="{{ form.address.id_for_label }}" class="form-label">
                            üè† –ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏ <span class="text-danger">*</span>
                        </label>

                        <textarea
                            name="{{ form.address.name }}"
                            id="{{ form.address.id_for_label }}"
                            class="form-control"
                            rows="3"
                            placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∞–¥—Ä–µ—Å... –ù–∞–ø—Ä–∏–º–µ—Ä: –ú–æ—Å–∫–≤–∞, —É–ª–∏—Ü–∞ –õ–µ–Ω–∏–Ω–∞"
                            autocomplete="off"
                            required>{{ form.address.value|default:'' }}</textarea>

                        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–æ–∫ -->
                        <div id="address-suggestions"
                             class="list-group position-absolute w-100 shadow-lg"
                             style="z-index: 1050; max-height: 400px; overflow-y: auto; display: none; border-radius: 15px; margin-top: 5px;">
                        </div>

                        {% if form.address.errors %}
                        <div class="text-danger small mt-1">
                            {{ form.address.errors }}
                        </div>
                        {% endif %}
                        <small class="form-text text-muted">
                            üí° –ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∞–¥—Ä–µ—Å - –ø–æ—è–≤—è—Ç—Å—è –ø–æ–¥—Å–∫–∞–∑–∫–∏. –í—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –≤—Ä—É—á–Ω—É—é.
                        </small>
                    </div>

                    <hr class="my-4">

                    <!-- Is Default -->
                    <div class="mb-4">
                        <div class="card" style="background-color: var(--milk-white); border: 2px solid var(--grey-green);">
                            <div class="card-body">
                                <div class="form-check">
                                    {{ form.is_default }}
                                    <label class="form-check-label" for="{{ form.is_default.id_for_label }}">
                                        <strong>‚≠ê –°–¥–µ–ª–∞—Ç—å –æ—Å–Ω–æ–≤–Ω—ã–º –∞–¥—Ä–µ—Å–æ–º</strong>
                                        <br>
                                        <small class="text-muted">–≠—Ç–æ—Ç –∞–¥—Ä–µ—Å –±—É–¥–µ—Ç –≤—ã–±—Ä–∞–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex gap-3">
                        <button type="submit" class="btn btn-primary flex-grow-1 btn-lg">
                            {% if form.instance.pk %}
                                üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                            {% else %}
                                ‚ûï –î–æ–±–∞–≤–∏—Ç—å –∞–¥—Ä–µ—Å
                            {% endif %}
                        </button>
                        <a href="{% url 'address-list' %}" class="btn btn-secondary btn-lg">
                            ‚ùå –û—Ç–º–µ–Ω–∞
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Help Card -->
        {% if not form.instance.pk %}
        <div class="card mt-4" style="background: linear-gradient(135deg, rgba(90, 112, 80, 0.05), rgba(166, 124, 82, 0.05));">
            <div class="card-body">
                <h6 style="color: var(--moss-green);">üí° –°–æ–≤–µ—Ç</h6>
                <p class="mb-0">–í—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∞–¥—Ä–µ—Å–æ–≤ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤: –¥–æ–º–∞—à–Ω–∏–π, —Ä–∞–±–æ—á–∏–π, –∞–¥—Ä–µ—Å –¥–ª—è –ø–æ–¥–∞—Ä–∫–æ–≤. –û–¥–∏–Ω –∏–∑ –Ω–∏—Ö –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –æ—Å–Ω–æ–≤–Ω—ã–º.</p>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .form-control, .form-select, textarea {
        background-color: white;
    }

    .form-control:focus, .form-select:focus, textarea:focus {
        background-color: white;
    }

    .form-check-input:checked {
        background-color: var(--moss-green);
        border-color: var(--moss-green);
    }

    .form-check-input:focus {
        border-color: var(--moss-green);
        box-shadow: 0 0 0 0.2rem rgba(90, 112, 80, 0.25);
    }

    textarea.form-control {
        min-height: 80px;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è */
    .suggestion-item {
        cursor: pointer;
        transition: all 0.2s;
        border: none !important;
        border-bottom: 1px solid var(--grey-green) !important;
    }

    .suggestion-item:last-child {
        border-bottom: none !important;
        border-radius: 0 0 15px 15px;
    }

    .suggestion-item:first-child {
        border-radius: 15px 15px 0 0;
    }

    .suggestion-item:hover {
        background-color: var(--grey-green) !important;
        transform: translateX(5px);
    }

    .suggestion-item.active {
        background-color: var(--grey-green) !important;
    }

    #address-suggestions {
        animation: slideDown 0.2s ease-out;
        background: white;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .address-loading {
        opacity: 0.6;
        pointer-events: none;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const addressInput = document.getElementById('{{ form.address.id_for_label }}');
    const suggestionsContainer = document.getElementById('address-suggestions');

    let debounceTimer;
    let selectedIndex = -1;

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
    addressInput.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        const query = this.value.trim();

        if (query.length < 3) {
            suggestionsContainer.style.display = 'none';
            return;
        }

        // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        addressInput.classList.add('address-loading');

        // –ó–∞–¥–µ—Ä–∂–∫–∞ 300–º—Å –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º
        debounceTimer = setTimeout(function() {
            fetchSuggestions(query);
        }, 300);
    });

    // –ó–∞–ø—Ä–æ—Å –ø–æ–¥—Å–∫–∞–∑–æ–∫
    function fetchSuggestions(query) {
        fetch(`{% url 'address-autocomplete' %}?query=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                addressInput.classList.remove('address-loading');
                displaySuggestions(data.suggestions || []);
            })
            .catch(error => {
                console.error('Error fetching suggestions:', error);
                addressInput.classList.remove('address-loading');
                suggestionsContainer.style.display = 'none';
            });
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–¥—Å–∫–∞–∑–æ–∫
    function displaySuggestions(suggestions) {
        if (suggestions.length === 0) {
            suggestionsContainer.style.display = 'none';
            return;
        }

        let html = '';
        suggestions.forEach(function(item, index) {
            const displayAddress = item.value || item.unrestricted_value;
            const postalCode = item.postal_code ? `üì¨ ${item.postal_code}` : '';

            html += `
                <button type="button"
                        class="list-group-item list-group-item-action suggestion-item p-3"
                        data-index="${index}"
                        data-full="${item.unrestricted_value}"
                        data-postal="${item.postal_code}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div style="flex: 1;">
                            <div style="color: var(--moss-green); font-weight: 600; margin-bottom: 4px;">
                                ${displayAddress}
                            </div>
                            ${postalCode ? `<small class="text-muted">${postalCode}</small>` : ''}
                        </div>
                        <small class="text-muted ms-2">üìç</small>
                    </div>
                </button>
            `;
        });

        suggestionsContainer.innerHTML = html;
        suggestionsContainer.style.display = 'block';
        selectedIndex = -1;

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–∞ –Ω–∞ –ø–æ–¥—Å–∫–∞–∑–∫–∏
        document.querySelectorAll('.suggestion-item').forEach(function(item) {
            item.addEventListener('click', function() {
                selectAddress(this.dataset.full);
            });
        });
    }

    // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª—è –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –∞–¥—Ä–µ—Å–∞
    function selectAddress(fullAddress) {
        addressInput.value = fullAddress;
        suggestionsContainer.style.display = 'none';
        selectedIndex = -1;

        // –í–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
        addressInput.style.borderColor = 'var(--moss-green)';
        addressInput.style.boxShadow = '0 0 0 0.2rem rgba(90, 112, 80, 0.25)';

        setTimeout(() => {
            addressInput.style.borderColor = '';
            addressInput.style.boxShadow = '';
        }, 2000);
    }

    // –°–∫—Ä—ã—Ç–∏–µ –ø–æ–¥—Å–∫–∞–∑–æ–∫ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
    document.addEventListener('click', function(event) {
        if (!addressInput.contains(event.target) &&
            !suggestionsContainer.contains(event.target)) {
            suggestionsContainer.style.display = 'none';
            selectedIndex = -1;
        }
    });

    // –ù–∞–≤–∏–≥–∞—Ü–∏—è —Å—Ç—Ä–µ–ª–∫–∞–º–∏
    addressInput.addEventListener('keydown', function(e) {
        const items = suggestionsContainer.querySelectorAll('.suggestion-item');

        if (items.length === 0) return;

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
            highlightItem(items, selectedIndex);

            // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ —ç–ª–µ–º–µ–Ω—Ç—É
            items[selectedIndex].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
        }
        else if (e.key === 'ArrowUp') {
            e.preventDefault();
            selectedIndex = Math.max(selectedIndex - 1, 0);
            highlightItem(items, selectedIndex);

            items[selectedIndex].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
        }
        else if (e.key === 'Enter' && selectedIndex >= 0) {
            e.preventDefault();
            items[selectedIndex].click();
        }
        else if (e.key === 'Escape') {
            suggestionsContainer.style.display = 'none';
            selectedIndex = -1;
        }
    });

    function highlightItem(items, index) {
        items.forEach((item, i) => {
            if (i === index) {
                item.classList.add('active');
            } else {
                item.classList.remove('active');
            }
        });
    }
});
</script>
{% endblock %}
"""
–î–æ–±–∞–≤—å—Ç–µ –≤ –±–ª–æ–∫ —Å –ø–æ–ª–µ–º address_line1 (–∑–∞–º–µ–Ω–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –±–ª–æ–∫):

<!-- Address Line 1 —Å –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ–º -->
<div class="mb-3 position-relative">
    <label for="{{ form.address_line1.id_for_label }}" class="form-label">
        üè† –ê–¥—Ä–µ—Å (—É–ª–∏—Ü–∞, –¥–æ–º) <span class="text-danger">*</span>
    </label>

    <input type="text"
           name="{{ form.address_line1.name }}"
           id="{{ form.address_line1.id_for_label }}"
           class="form-control"
           placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∞–¥—Ä–µ—Å..."
           value="{{ form.address_line1.value|default:'' }}"
           autocomplete="off"
           required>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–æ–∫ -->
    <div id="address-suggestions"
         class="list-group position-absolute w-100 shadow-lg"
         style="z-index: 1050; max-height: 300px; overflow-y: auto; display: none; border-radius: 15px; margin-top: 5px;">
    </div>

    {% if form.address_line1.errors %}
    <div class="text-danger small mt-1">
        {{ form.address_line1.errors }}
    </div>
    {% endif %}
    <small class="form-text text-muted">–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∞–¥—Ä–µ—Å - –ø–æ—è–≤—è—Ç—Å—è –ø–æ–¥—Å–∫–∞–∑–∫–∏</small>
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const addressInput = document.getElementById('{{ form.address_line1.id_for_label }}');
    const suggestionsContainer = document.getElementById('address-suggestions');

    // –ü–æ–ª—è –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
    const countryField = document.getElementById('{{ form.country.id_for_label }}');
    const cityField = document.getElementById('{{ form.city.id_for_label }}');
    const postalCodeField = document.getElementById('{{ form.postal_code.id_for_label }}');
    const regionField = document.getElementById('{{ form.region.id_for_label }}');

    let debounceTimer;

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–≤–æ–¥–∞ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
    addressInput.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        const query = this.value.trim();

        if (query.length < 3) {
            suggestionsContainer.style.display = 'none';
            return;
        }

        // –ó–∞–¥–µ—Ä–∂–∫–∞ 300–º—Å –ø–µ—Ä–µ–¥ –∑–∞–ø—Ä–æ—Å–æ–º
        debounceTimer = setTimeout(function() {
            fetchSuggestions(query);
        }, 300);
    });

    // –ó–∞–ø—Ä–æ—Å –ø–æ–¥—Å–∫–∞–∑–æ–∫
    function fetchSuggestions(query) {
        fetch(`{% url 'address-autocomplete' %}?query=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                displaySuggestions(data.suggestions || []);
            })
            .catch(error => {
                console.error('Error fetching suggestions:', error);
                suggestionsContainer.style.display = 'none';
            });
    }

    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–¥—Å–∫–∞–∑–æ–∫
    function displaySuggestions(suggestions) {
        if (suggestions.length === 0) {
            suggestionsContainer.style.display = 'none';
            return;
        }

        let html = '';
        suggestions.forEach(function(item) {
            html += `
                <button type="button"
                        class="list-group-item list-group-item-action suggestion-item p-3"
                        data-full="${item.unrestricted_value}"
                        data-country="${item.country}"
                        data-region="${item.region}"
                        data-city="${item.city}"
                        data-postal="${item.postal_code}"
                        data-street="${item.street}"
                        data-house="${item.house}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <div style="color: var(--moss-green); font-weight: 600;">
                                ${item.value}
                            </div>
                            ${item.postal_code ? `<small class="text-muted">üì¨ ${item.postal_code}</small>` : ''}
                        </div>
                        <small class="text-muted">üìç</small>
                    </div>
                </button>
            `;
        });

        suggestionsContainer.innerHTML = html;
        suggestionsContainer.style.display = 'block';

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–∞ –Ω–∞ –ø–æ–¥—Å–∫–∞–∑–∫–∏
        document.querySelectorAll('.suggestion-item').forEach(function(item) {
            item.addEventListener('click', function() {
                selectAddress(this.dataset);
            });
        });
    }

    // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª–µ–π –ø—Ä–∏ –≤—ã–±–æ—Ä–µ –∞–¥—Ä–µ—Å–∞
    function selectAddress(data) {
        // –ó–∞–ø–æ–ª–Ω—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–µ –ø–æ–ª–µ
        addressInput.value = (data.street + ' ' + data.house).trim();

        // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥—Ä—É–≥–∏—Ö –ø–æ–ª–µ–π
        if (countryField) countryField.value = data.country || '–†–æ—Å—Å–∏—è';
        if (cityField) cityField.value = data.city || '';
        if (postalCodeField) postalCodeField.value = data.postal || '';
        if (regionField) regionField.value = data.region || '';

        // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫–∏
        suggestionsContainer.style.display = 'none';

        // –í–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
        [addressInput, countryField, cityField, postalCodeField, regionField].forEach(field => {
            if (field && field.value) {
                field.style.borderColor = 'var(--moss-green)';
                setTimeout(() => {
                    field.style.borderColor = '';
                }, 2000);
            }
        });
    }

    // –°–∫—Ä—ã—Ç–∏–µ –ø–æ–¥—Å–∫–∞–∑–æ–∫ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ
    document.addEventListener('click', function(event) {
        if (!addressInput.contains(event.target) &&
            !suggestionsContainer.contains(event.target)) {
            suggestionsContainer.style.display = 'none';
        }
    });

    // –ù–∞–≤–∏–≥–∞—Ü–∏—è —Å—Ç—Ä–µ–ª–∫–∞–º–∏
    let selectedIndex = -1;
    addressInput.addEventListener('keydown', function(e) {
        const items = suggestionsContainer.querySelectorAll('.suggestion-item');

        if (e.key === 'ArrowDown') {
            e.preventDefault();
            selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
            highlightItem(items, selectedIndex);
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            selectedIndex = Math.max(selectedIndex - 1, 0);
            highlightItem(items, selectedIndex);
        } else if (e.key === 'Enter' && selectedIndex >= 0) {
            e.preventDefault();
            items[selectedIndex].click();
        } else if (e.key === 'Escape') {
            suggestionsContainer.style.display = 'none';
            selectedIndex = -1;
        }
    });

    function highlightItem(items, index) {
        items.forEach((item, i) => {
            if (i === index) {
                item.style.backgroundColor = 'var(--grey-green)';
            } else {
                item.style.backgroundColor = '';
            }
        });
    }
});
</script>

<style>
    .suggestion-item {
        cursor: pointer;
        transition: all 0.2s;
        border: none !important;
        border-bottom: 1px solid var(--grey-green) !important;
    }

    .suggestion-item:last-child {
        border-bottom: none !important;
        border-radius: 0 0 15px 15px;
    }

    .suggestion-item:first-child {
        border-radius: 15px 15px 0 0;
    }

    .suggestion-item:hover {
        background-color: var(--grey-green) !important;
        transform: translateX(5px);
    }

    #address-suggestions {
        animation: slideDown 0.2s ease-out;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}