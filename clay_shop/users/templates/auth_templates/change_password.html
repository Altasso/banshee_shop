{% extends 'general_templates/base.html' %}

{% block title %}–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è - Clay Art{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">–ì–ª–∞–≤–Ω–∞—è</a></li>
                <li class="breadcrumb-item"><a href="{% url 'user-profile' %}">–ü—Ä–æ—Ñ–∏–ª—å</a></li>
                <li class="breadcrumb-item active">–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-lg-6 col-md-8">
        <div class="card">
            <div class="card-header">
                <h3 class="mb-0">üîí –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è</h3>
            </div>
            <div class="card-body p-4">
                <div class="alert alert-info mb-4">
                    <strong>üí° –°–æ–≤–µ—Ç:</strong> –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –Ω–∞–¥–µ–∂–Ω—ã–π –ø–∞—Ä–æ–ª—å –¥–ª–∏–Ω–æ–π –º–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã.
                </div>

                <form method="post" hx-post="{% url 'change-password' %}" hx-target="this" hx-swap="outerHTML">
                    {% csrf_token %}
                    
                    {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        {{ form.non_field_errors }}
                    </div>
                    {% endif %}

                    <!-- Old Password -->
                    <div class="mb-3">
                        <label for="{{ form.old_password.id_for_label }}" class="form-label">
                            üîë –¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å <span class="text-danger">*</span>
                        </label>
                        <div class="input-group">
                            <input type="password" 
                                   name="old_password" 
                                   class="form-control form-control-lg" 
                                   id="{{ form.old_password.id_for_label }}"
                                   placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å"
                                   required
                                   autofocus>
                            <button class="btn btn-outline-secondary" 
                                    type="button" 
                                    onclick="togglePassword('{{ form.old_password.id_for_label }}', this)">
                                üëÅÔ∏è
                            </button>
                        </div>
                        {% if form.old_password.errors %}
                        <div class="text-danger small mt-1">
                            {{ form.old_password.errors }}
                        </div>
                        {% endif %}
                        <small class="form-text text-muted">–î–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å</small>
                    </div>

                    <hr class="my-4">

                    <!-- New Password -->
                    <div class="mb-3">
                        <label for="{{ form.new_password.id_for_label }}" class="form-label">
                            üîê –ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å <span class="text-danger">*</span>
                        </label>
                        <div class="input-group">
                            <input type="password" 
                                   name="new_password" 
                                   class="form-control form-control-lg" 
                                   id="{{ form.new_password.id_for_label }}"
                                   placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å"
                                   required>
                            <button class="btn btn-outline-secondary" 
                                    type="button" 
                                    onclick="togglePassword('{{ form.new_password.id_for_label }}', this)">
                                üëÅÔ∏è
                            </button>
                        </div>
                        {% if form.new_password.errors %}
                        <div class="text-danger small mt-1">
                            {{ form.new_password.errors }}
                        </div>
                        {% endif %}
                        <small class="form-text text-muted">–ú–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤</small>
                    </div>

                    <!-- Confirm New Password -->
                    <div class="mb-4">
                        <label for="{{ form.confirm_password.id_for_label }}" class="form-label">
                            üîê –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–∞—Ä–æ–ª—è <span class="text-danger">*</span>
                        </label>
                        <div class="input-group">
                            <input type="password" 
                                   name="confirm_password" 
                                   class="form-control form-control-lg" 
                                   id="{{ form.confirm_password.id_for_label }}"
                                   placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å"
                                   required>
                            <button class="btn btn-outline-secondary" 
                                    type="button" 
                                    onclick="togglePassword('{{ form.confirm_password.id_for_label }}', this)">
                                üëÅÔ∏è
                            </button>
                        </div>
                        {% if form.confirm_password.errors %}
                        <div class="text-danger small mt-1">
                            {{ form.confirm_password.errors }}
                        </div>
                        {% endif %}
                        <small class="form-text text-muted">–ü–∞—Ä–æ–ª–∏ –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å</small>
                    </div>

                    <!-- Password Strength Indicator -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small class="text-muted">–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å –ø–∞—Ä–æ–ª—è:</small>
                            <small id="strength-text" class="text-muted">–ù–µ —É–∫–∞–∑–∞–Ω</small>
                        </div>
                        <div class="progress" style="height: 8px; border-radius: 10px;">
                            <div id="strength-bar" 
                                 class="progress-bar" 
                                 role="progressbar" 
                                 style="width: 0%; transition: all 0.3s ease;"
                                 aria-valuenow="0" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-3">
                        <button type="submit" class="btn btn-primary btn-lg">
                            üíæ –ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å
                        </button>
                        <a href="{% url 'user-profile' %}" class="btn btn-secondary btn-lg">
                            ‚ùå –û—Ç–º–µ–Ω–∞
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Security Tips Card -->
        <div class="card mt-4" style="background: linear-gradient(135deg, rgba(90, 112, 80, 0.05), rgba(166, 124, 82, 0.05)); border: none;">
            <div class="card-body">
                <h6 style="color: var(--moss-green);" class="mb-3">üõ°Ô∏è –°–æ–≤–µ—Ç—ã –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</h6>
                <ul class="mb-0" style="font-size: 0.9rem;">
                    <li class="mb-2">–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–∞–π—Ç–∞</li>
                    <li class="mb-2">–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª–∏—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é (–∏–º—è, –¥–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è)</li>
                    <li class="mb-2">–ö–æ–º–±–∏–Ω–∏—Ä—É–π—Ç–µ –∑–∞–≥–ª–∞–≤–Ω—ã–µ –∏ —Å—Ç—Ä–æ—á–Ω—ã–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ —Å–∏–º–≤–æ–ª—ã</li>
                    <li class="mb-2">–†–µ–≥—É–ª—è—Ä–Ω–æ –º–µ–Ω—è–π—Ç–µ –ø–∞—Ä–æ–ª—å (—Ä–∞–∑ –≤ 3-6 –º–µ—Å—è—Ü–µ–≤)</li>
                    <li>–ù–∏–∫–æ–≥–¥–∞ –Ω–µ —Å–æ–æ–±—â–∞–π—Ç–µ —Å–≤–æ–π –ø–∞—Ä–æ–ª—å –¥—Ä—É–≥–∏–º –ª—é–¥—è–º</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .form-control-lg {
        padding: 0.75rem 1.25rem;
        font-size: 1rem;
    }
    
    .input-group .btn-outline-secondary {
        border-color: var(--grey-green);
        color: var(--moss-green);
    }
    
    .input-group .btn-outline-secondary:hover {
        background-color: var(--moss-green);
        border-color: var(--moss-green);
        color: white;
    }

    input.form-control:focus {
        border-color: var(--moss-green);
        box-shadow: 0 0 0 0.2rem rgba(90, 112, 80, 0.15);
    }

    .progress {
        background-color: var(--grey-green);
    }

    .card {
        animation: fadeIn 0.5s ease-in;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Toggle password visibility
    function togglePassword(fieldId, button) {
        const field = document.getElementById(fieldId);
        if (field.type === 'password') {
            field.type = 'text';
            button.textContent = 'üôà';
        } else {
            field.type = 'password';
            button.textContent = 'üëÅÔ∏è';
        }
    }

    // Password strength checker
    document.addEventListener('DOMContentLoaded', function() {
        const newPasswordField = document.getElementById('{{ form.new_password.id_for_label }}');
        if (newPasswordField) {
            newPasswordField.addEventListener('input', function() {
                checkPasswordStrength(this.value);
            });
        }
    });

    function checkPasswordStrength(password) {
        const strengthBar = document.getElementById('strength-bar');
        const strengthText = document.getElementById('strength-text');
        
        if (!password) {
            strengthBar.style.width = '0%';
            strengthBar.className = 'progress-bar';
            strengthText.textContent = '–ù–µ —É–∫–∞–∑–∞–Ω';
            return;
        }

        let strength = 0;
        let text = '';
        let colorClass = '';

        // Length
        if (password.length >= 8) strength += 25;
        if (password.length >= 12) strength += 15;

        // Contains lowercase
        if (/[a-z]/.test(password)) strength += 15;

        // Contains uppercase
        if (/[A-Z]/.test(password)) strength += 15;

        // Contains numbers
        if (/\d/.test(password)) strength += 15;

        // Contains special characters
        if (/[^a-zA-Z0-9]/.test(password)) strength += 15;

        // Determine strength level
        if (strength < 30) {
            text = '–°–ª–∞–±—ã–π';
            colorClass = 'bg-danger';
        } else if (strength < 60) {
            text = '–°—Ä–µ–¥–Ω–∏–π';
            colorClass = 'bg-warning';
        } else if (strength < 85) {
            text = '–•–æ—Ä–æ—à–∏–π';
            colorClass = 'bg-info';
        } else {
            text = '–û—Ç–ª–∏—á–Ω—ã–π';
            colorClass = 'bg-success';
        }

        strengthBar.style.width = strength + '%';
        strengthBar.className = 'progress-bar ' + colorClass;
        strengthText.textContent = text;
    }
</script>
{% endblock %}